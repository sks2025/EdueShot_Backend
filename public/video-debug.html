<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Debug Tool - Edu Spark</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        .video-test {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .video-test h3 {
            margin-top: 0;
            color: #333;
        }
        video {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 4px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .url-test {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .url-test a {
            color: #007bff;
            text-decoration: none;
            word-break: break-all;
        }
        .url-test a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Video Debug Tool</h1>
        <p>This tool helps diagnose video playback issues by testing different video sources and configurations.</p>
        
        <button onclick="runAllTests()">üöÄ Run All Tests</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        
        <div id="videoContainer" class="video-container"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3002/api';
        const STATIC_BASE = 'http://localhost:3002/uploads';
        
        async function runAllTests() {
            clearResults();
            
            try {
                // Get videos from API
                const response = await fetch(`${API_BASE}/videos`);
                const videos = await response.json();
                
                if (videos.length === 0) {
                    showResult('No videos found in database', 'error');
                    return;
                }
                
                showResult(`Found ${videos.length} video(s) from API`, 'success');
                
                // Test each video
                for (let i = 0; i < Math.min(videos.length, 3); i++) {
                    await testVideo(videos[i]);
                }
                
            } catch (error) {
                showResult(`Error fetching videos: ${error.message}`, 'error');
            }
        }
        
        async function testVideo(video) {
            const container = document.getElementById('videoContainer');
            
            // Extract filename from videoUrl
            const filename = video.videoUrl.includes('/uploads/') 
                ? video.videoUrl.split('/uploads/')[1] 
                : video.videoUrl.replace('/uploads/', '');
            
            const staticUrl = `${STATIC_BASE}/${filename}`;
            const streamUrl = `${API_BASE}/videos/${video._id}/stream`;
            
            const videoTestDiv = document.createElement('div');
            videoTestDiv.className = 'video-test';
            videoTestDiv.innerHTML = `
                <h3>üìπ ${video.title}</h3>
                <p><strong>ID:</strong> ${video._id}</p>
                <p><strong>Type:</strong> ${video.contentType}</p>
                <p><strong>Categories:</strong> ${video.category.join(', ')}</p>
                
                <div class="url-test">
                    <h4>üîó Test URLs:</h4>
                    <p><strong>Direct URL:</strong> <a href="${staticUrl}" target="_blank">${staticUrl}</a></p>
                    <p><strong>Stream URL:</strong> <a href="${streamUrl}" target="_blank">${streamUrl}</a></p>
                    <p><strong>API URL:</strong> <a href="${video.videoUrl}" target="_blank">${video.videoUrl}</a></p>
                </div>
                
                <h4>üé• Test Videos:</h4>
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div>
                        <h5>Static File Test:</h5>
                        <video id="static-${video._id}" controls preload="metadata" style="width: 200px;">
                            <source src="${staticUrl}" type="video/mp4">
                            Static file not available
                        </video>
                        <div id="static-result-${video._id}" class="test-result"></div>
                    </div>
                    
                    <div>
                        <h5>Stream API Test:</h5>
                        <video id="stream-${video._id}" controls preload="metadata" style="width: 200px;">
                            <source src="${streamUrl}" type="video/mp4">
                            Stream not available
                        </video>
                        <div id="stream-result-${video._id}" class="test-result"></div>
                    </div>
                    
                    <div>
                        <h5>API URL Test:</h5>
                        <video id="api-${video._id}" controls preload="metadata" style="width: 200px;">
                            <source src="${video.videoUrl}" type="video/mp4">
                            API URL not available
                        </video>
                        <div id="api-result-${video._id}" class="test-result"></div>
                    </div>
                </div>
                
                <div id="debug-${video._id}" class="debug-info"></div>
            `;
            
            container.appendChild(videoTestDiv);
            
            // Test each video source
            await testVideoElement(`static-${video._id}`, `static-result-${video._id}`, staticUrl);
            await testVideoElement(`stream-${video._id}`, `stream-result-${video._id}`, streamUrl);
            await testVideoElement(`api-${video._id}`, `api-result-${video._id}`, video.videoUrl);
            
            // Collect debug information
            const debugInfo = `
Video ${video._id} Debug Info:
- Static URL Status: ${await checkUrlStatus(staticUrl)}
- Stream URL Status: ${await checkUrlStatus(streamUrl)}
- API URL Status: ${await checkUrlStatus(video.videoUrl)}
- Filename: ${filename}
- File Size: ${await getFileSize(staticUrl)}
            `;
            
            document.getElementById(`debug-${video._id}`).textContent = debugInfo;
        }
        
        async function testVideoElement(elementId, resultId, url) {
            const video = document.getElementById(elementId);
            const result = document.getElementById(resultId);
            
            return new Promise((resolve) => {
                let resolved = false;
                
                const handleLoad = () => {
                    if (resolved) return;
                    resolved = true;
                    result.innerHTML = '<span class="test-result success">‚úÖ Loaded successfully</span>';
                    resolve();
                };
                
                const handleError = () => {
                    if (resolved) return;
                    resolved = true;
                    result.innerHTML = '<span class="test-result error">‚ùå Failed to load</span>';
                    
                    // Add more detailed error info
                    const errorInfo = video.error ? `
                        Error Code: ${video.error.code}
                        Error Message: ${video.error.message}
                    ` : 'Unknown error';
                    result.innerHTML += `<div class="debug-info" style="margin-top: 5px;">${errorInfo}</div>`;
                    resolve();
                };
                
                video.addEventListener('loadstart', () => {
                    if (!resolved) {
                        result.innerHTML = '<span class="test-result info">üîÑ Loading...</span>';
                    }
                });
                
                video.addEventListener('loadeddata', handleLoad);
                video.addEventListener('error', handleError);
                
                video.addEventListener('canplay', () => {
                    if (!resolved) {
                        result.innerHTML = '<span class="test-result success">‚úÖ Ready to play</span>';
                        resolved = true;
                        resolve();
                    }
                });
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        result.innerHTML = '<span class="test-result error">‚è∞ Timeout</span>';
                        resolve();
                    }
                }, 10000);
                
                // Force load the video
                video.load();
            });
        }
        
        async function checkUrlStatus(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return `${response.status} ${response.statusText}`;
            } catch (error) {
                return `Error: ${error.message}`;
            }
        }
        
        async function getFileSize(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                const size = response.headers.get('Content-Length');
                return size ? `${(size / 1024 / 1024).toFixed(2)} MB` : 'Unknown';
            } catch (error) {
                return 'Error';
            }
        }
        
        function showResult(message, type) {
            const container = document.getElementById('videoContainer');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            container.appendChild(resultDiv);
        }
        
        function clearResults() {
            document.getElementById('videoContainer').innerHTML = '';
        }
    </script>
</body>
</html>

