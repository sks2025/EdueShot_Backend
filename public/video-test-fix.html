<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Test - URL Encoding Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        video {
            width: 100%;
            max-width: 600px;
            height: auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .url-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .error {
            color: red;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background-color: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .available-files {
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ¥ Video URL Encoding Test</h1>
    
    <div class="test-section">
        <h3>Your Original Video URL:</h3>
        <input type="text" class="url-input" id="originalUrl" value="http://localhost:3002/uploads/1759600484608-his%20last%20walk%20destroy%20in%20sec%20%F0%9F%A5%B1%F0%9F%98%AD%20#angmutyangsectione%20#amnse%20#kdrama%20#filipinodrama%20#sectione%20-%20Soraaa%F0%9F%A6%8B%20(144p,%20h264).mp4" readonly>
        <button onclick="testOriginalUrl()">Test Original URL</button>
    </div>

    <div class="test-section">
        <h3>Manual Test:</h3>
        <label for="manualUrl">Enter any video URL to test:</label>
        <input type="text" class="url-input" id="manualUrl" placeholder="http://localhost:3002/uploads/your-video-name.mp4">
        <button onclick="testManualUrl()">Test Manual URL</button>
    </div>

    <div class="test-section">
        <h3>Auto-test Available Files:</h3>
        <button onclick="loadAvailableFiles()">Load Available Files</button>
        <div id="availableFiles"></div>
    </div>

    <div class="test-section">
        <h3>Video Player:</h3>
        <video id="videoPlayer" controls preload="metadata">
            <source src="" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <div id="statusMessages"></div>

    <script>
        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusMessages');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            container.appendChild(div);
            
            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
            
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function testOriginalUrl() {
            const url = document.getElementById('originalUrl').value;
            showStatus('Testing original URL...', 'info');
            testVideoUrl(url);
        }

        function testManualUrl() {
            const url = document.getElementById('manualUrl').value;
            if (!url) {
                showStatus('Please enter a URL to test', 'error');
                return;
            }
            showStatus('Testing manual URL...', 'info');
            testVideoUrl(url);
        }

        function testVideoUrl(url) {
            showStatus(`Testing URL: ${url}`, 'info');
            
            const video = document.getElementById('videoPlayer');
            
            // Clear any error state
            video.className = '';
            
            // Set video source
            video.src = url;
            
            // Test with fetch first to check if file exists
            fetch(url, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        showStatus('âœ… File exists and is accessible!', 'success');
                        showStatus(`Content-Length: ${response.headers.get('Content-Length')} bytes`, 'info');
                        showStatus(`Content-Type: ${response.headers.get('Content-Type')}`, 'info');
                        
                        // Now load video
                        video.load();
                    } else {
                        showStatus(`âŒ HTTP Error ${response.status}: ${response.statusText}`, 'error');
                        if (response.status === 404) {
                            showStatus('File not found. The file might have been moved or deleted.', 'error');
                        }
                    }
                })
                .catch(error => {
                    showStatus(`âŒ Network Error: ${error.message}`, 'error');
                    showStatus('Check if server is running on localhost:3002', 'error');
                });
        }

        function loadAvailableFiles() {
            showStatus('Loading available files...', 'info');
            
            fetch('http://localhost:3002/api/videos')
                .then(response => response.json())
                .then(data => {
                    if (data && Array.isArray(data)) {
                        const container = document.getElementById('availableFiles');
                        container.innerHTML = '';
                        
                        const h4 = document.createElement('h4');
                        h4.textContent = `Found ${data.length} videos:`;
                        container.appendChild(h4);
                        
                        const filesDiv = document.createElement('div');
                        filesDiv.className = 'available-files';
                        
                        data.forEach((video, index) => {
                            const div = document.createElement('div');
                            div.style.marginBottom = '5px';
                            div.style.cursor = 'pointer';
                            div.innerHTML = `${index + 1}. <strong>${video.title}</strong><br><small>${video.videoUrl}</small><br>`;
                            div.onclick = () => {
                                document.getElementById('manualUrl').value = video.videoUrl;
                                testVideoUrl(video.videoUrl);
                            };
                            filesDiv.appendChild(div);
                        });
                        
                        container.appendChild(filesDiv);
                        showStatus(`âœ… Loaded ${data.length} videos successfully!`, 'success');
                    } else {
                        showStatus('âŒ Failed to load videos or invalid response format', 'error');
                        console.log('API Response:', data);
                    }
                })
                .catch(error => {
                    showStatus(`âŒ Error loading videos: ${error.message}`, 'error');
                    console.error('Error:', error);
                });
        }

        // Video event listeners
        const video = document.getElementById('videoPlayer');
        
        video.addEventListener('loadstart', () => {
            showStatus('ðŸ”„ Video loading started...', 'info');
        });
        
        video.addEventListener('loadeddata', () => {
            showStatus('âœ… Video data loaded successfully!', 'success');
        });
        
        video.addEventListener('canplay', () => {
            showStatus('âœ… Video ready to play!', 'success');
        });
        
        video.addEventListener('error', (e) => {
            const error = video.error;
            let errorMessage = 'Unknown error';
            
            if (error) {
                switch(error.code) {
                    case error.MEDIA_ERR_ABORTED:
                        errorMessage = 'Video loading aborted';
                        break;
                    case error.MEDIA_ERR_NETWORK:
                        errorMessage = 'Network error while loading video';
                        break;
                    case error.MEDIA_ERR_DECODE:
                        errorMessage = 'Video decode error';
                        break;
                    case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        errorMessage = 'Video format not supported or file not found';
                        break;
                    default:
                        errorMessage = `Unknown error (code: ${error.code})`;
                }
            }
            
            showStatus(`âŒ Video Error: ${errorMessage}`, 'error');
        });

        // Auto-load available files on page load
        window.addEventListener('load', () => {
            showStatus('ðŸš€ Video Test Page Loaded!', 'info');
            loadAvailableFiles();
        });
    </script>
</body>
</html>

